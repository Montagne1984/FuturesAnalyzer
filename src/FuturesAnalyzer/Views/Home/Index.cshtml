@model FuturesAnalyzer.ViewModels.ReportSettingViewModel
@{
    ViewData["Title"] = "Home Page";
}
<form id="form" asp-action="Report" method="post" class="form-inline" style="margin-top: 20px;">
    <div class="form-group form-inline">
        <label asp-for="TransactionFeeRate">交易手续费率</label>
        <input type="number" min="0" step="0.0001" asp-for="TransactionFeeRate" class="form-control" />
    </div>
    <div class="form-group">
        <label asp-for="StopLossCriteria">止损点</label>
        <input type="number" min="0" step="0.01" asp-for="StopLossCriteria" class="form-control" />
    </div>
    <div class="form-group form-inline">
        <label asp-for="StopProfitCriteria">止盈点</label>
        <input type="number" min="0" step="0.1" asp-for="StopProfitCriteria" class="form-control" />
    </div>
    <div class="form-group form-inline">
        <label asp-for="StartProfitCriteria">起盈点</label>
        <input type="number" min="0" step="0.01" asp-for="StartProfitCriteria" class="form-control" />
    </div>
    <div class="form-group form-inline">
        <label asp-for="OpenCriteria">开仓点</label>
        <input type="number" min="0" step="0.01" asp-for="OpenCriteria" class="form-control" />
    </div>
    <div class="checkbox">
        <label asp-for="FollowTrend">
            <input asp-for="FollowTrend" type="checkbox"> 开仓顺势
        </label>
    </div>
    <select asp-for="SelectedProductName" class="form-control">
        <option>热轧卷板</option>
        <option>铝</option>
        <option>橡胶</option>
        <option>锌</option>
        <option>铜</option>
        <option>螺纹钢</option>
        <option>线材</option>
        <option>铅</option>
        <option>白银</option>
        <option>沥青</option>
        <option>锡</option>
        <option>镍</option>
    </select>
    <div class="form-group form-inline">
        <label asp-for="OpenCriteria">起始日期</label>
        <input type="date" asp-for="StartDate" class="form-control" />
    </div>
    <div class="form-group form-inline">
        <label asp-for="OpenCriteria">结束日期</label>
        <input type="date" asp-for="EndDate" class="form-control" />
    </div>
    <button id="analyze" type="submit" class="btn btn-primary">分析</button>
</form>
<div id="chart"></div>
<label id="summary"></label>
@section scripts
{
    <script src="http://code.highcharts.com/highcharts.js"></script>
    <script>
        $().ready(function () {
            var d = new Date();
            d.setDate(d.getDate() - 1);
            $('#EndDate').val(toDateFormat(d));
            d.setDate(d.getDate() - 365);
            $('#StartDate').val(toDateFormat(d));
        });
        function toDateFormat(date) {
            var month = date.getMonth() + 1;
            var fullMonth = month >= 10 ? month : '0' + month;
            var day = date.getDate();
            var fullDay = day >= 10 ? day : '0' + day;
            return date.getFullYear() + "-" + fullMonth + "-" + fullDay;
        }

        $('#form').submit(function (event) {
            event.preventDefault();
            var $inputs = $('#form input');
            var values = {};
            $inputs.each(function () {
                values[this.name] = $(this).val();
            });
            values['SelectedProductName'] = $('#SelectedProductName').val();
            values['FollowTrend'] = $('#FollowTrend')[0].checked;
            $.post($('#form').attr('action'), values, function (data) {
                var categories = [];
                var contracts = [];
                var balances = [];
                var maxSingleDelta = 0;
                var minSingleDelta = 0;
                var minBalance = 0;
                var maxBalance = 0;
                var lastBalance = 0;
                var annualProfits = {};
                var lastYearEndBalance = 0;
                var yesterdayYear = 0;
                $.each(data, function (index, value) {
                    categories.push(value.Date);
                    contracts.push(value.Contract ? value.Contract.Price * value.Contract.Direction : 0);
                    balances.push(value.Balance);
                    var delta = value.Balance - lastBalance;
                    maxSingleDelta = Math.max(maxSingleDelta, delta);
                    minSingleDelta = Math.min(minSingleDelta, delta);
                    maxBalance = Math.max(maxBalance, value.Balance);
                    minBalance = Math.min(minBalance, value.Balance);
                    lastBalance = value.Balance;
                    var date = new Date(value.Date);
                    var year = date.getFullYear();
                    if (year !== yesterdayYear) {
                        if (yesterdayYear !== 0) {
                            annualProfits[yesterdayYear] = data[index - 1].Balance - lastYearEndBalance;
                            lastYearEndBalance = data[index - 1].Balance;
                        }
                        yesterdayYear = year;
                    }
                });

                var endDate = new Date(data[data.length - 1].Date);
                var endYear = endDate.getFullYear();
                annualProfits[endYear] = data[data.length - 1].Balance - lastYearEndBalance;

                var summaryText = '最大盈利：' + maxBalance + '，最小盈利：' + minBalance + '，最大单日盈利：' + maxSingleDelta + '，最大单日亏损：' + minSingleDelta;
                summaryText += '<br/>';
                $.each(annualProfits, function (key, value) {
                    summaryText += key + '盈利：' + value + '&nbsp;&nbsp;&nbsp;';
                });

                $('#summary').html(summaryText);

                $('#chart').highcharts({
                    chart: {
                        zoomType: 'x'
                    },
                    title: {
                        text: values['SelectedProductName']
                    },
                    xAxis: [{
                        categories: categories,
                        crosshair: true
                    }],
                    yAxis: [{ // Primary yAxis
                        title: {
                            text: '盈亏',
                            style: {
                                color: Highcharts.getOptions().colors[0]
                            }
                        },
                        labels: {
                            format: '{value}元',
                            style: {
                                color: Highcharts.getOptions().colors[0]
                            }
                        }
                    }, { // Secondary yAxis
                        labels: {
                            format: '{value}元',
                            style: {
                                color: Highcharts.getOptions().colors[1]
                            }
                        },
                        title: {
                            text: '合约价格',
                            style: {
                                color: Highcharts.getOptions().colors[1]
                            }
                        },
                        opposite: true
                    }],
                    tooltip: {
                        shared: true
                    },
                    series: [{
                        name: '合约价格',
                        type: 'column',
                        yAxis: 1,
                        data: contracts,
                        tooltip: {
                            valueSuffix: '元'
                        }

                    }, {
                        name: '盈亏',
                        type: 'spline',
                        data: balances,
                        tooltip: {
                            valueSuffix: '元'
                        }
                    }]
                });
            });
        });

        var settings = {
            '铝': {
                TransactionFeeRate: 0.0008,
                StopLossCriteria: 0.02,
                StopProfitCriteria: 0.2,
                StartProfitCriteria: 0.1,
                OpenCriteria: 0.01,
                FollowTrend: false
            },
            '热轧卷板': {
                TransactionFeeRate: 0.0008,
                StopLossCriteria: 0.01,
                StopProfitCriteria: 0.1,
                StartProfitCriteria: 0.16,
                OpenCriteria: 0.01,
                FollowTrend: true
            },
            '白银': {
                TransactionFeeRate: 0.0008,
                StopLossCriteria: 0.01,
                StopProfitCriteria: 0.1,
                StartProfitCriteria: 0.12,
                OpenCriteria: 0.02,
                FollowTrend: false
            }
        };

        $('#SelectedProductName').change(function() {
            var selectedProductName = $('#SelectedProductName').val();
            if (settings[selectedProductName]) {
                $('#TransactionFeeRate').val(settings[selectedProductName].TransactionFeeRate);
                $('#StopLossCriteria').val(settings[selectedProductName].StopLossCriteria);
                $('#StopProfitCriteria').val(settings[selectedProductName].StopProfitCriteria);
                $('#StartProfitCriteria').val(settings[selectedProductName].StartProfitCriteria);
                $('#OpenCriteria').val(settings[selectedProductName].OpenCriteria);
                $('#FollowTrend').prop('checked', settings[selectedProductName].FollowTrend);
            }
        });
    </script>
}